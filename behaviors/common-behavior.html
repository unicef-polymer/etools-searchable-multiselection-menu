<script>
  window.etoolsSearchableDropdown = window.etoolsSearchableDropdown || {};
  /** @polymerBehavior etoolsSearchableDropdown.CommonBehavior */
  etoolsSearchableDropdown.CommonBehavior = { // eslint-disable-line no-undef
    properties: {
      label: {
        type: String
      },
      noLabelFloat: Boolean,
      required: {
        type: Boolean
      },
      search: {
        type: String,
        observer: '_searchValueChanged'
      },
      options: {
        type: Array
      },
      shownOptions: {
        type: Array,
        computed: '_computeShownOptions(options, search, showEmptyValue, options.length)'
      },
      optionValue: {
        type: String,
        value: 'value'
      },
      optionLabel: {
        type: String,
        value: 'label'
      },
      dynamicAlign: {
        type: Boolean,
        value: true
      },
      allowOutsideScroll: {
        type: Boolean
      },
      showEmptyValue: {
        type: Boolean,
        value: false
      },
      hideSearch: {
        type: Boolean,
        value: false
      },
      disabled: {
        type: Boolean,
        value: false
      },
      readonly: {
        type: Boolean,
        value: function() {
          return false;
        },
        reflectToAttribute: true,
        observer: '_readonlyChanged'
      },
      starred: {
        type: Boolean,
        value: false,
        reflectToAttribute: true,
        observer: '_attributeRepaintNeeded'
      },
      invalid: {
        type: Boolean,
        value: function() {
          return false;
        },
        reflectToAttribute: true
      },
      errorMessage: {
        type: String
      },
      shownOptionsLimit: {
        type: Number,
        value: 50
      },
      noOptionsAvailable: {
        type: Boolean,
        value: true,
        computed: '_computeNoOptionsAvailable(options, options.length)'
      },
      showLimitWarning: {
        type: Boolean,
        value: false,
        computed: '_computeShowLimitWarning(shownOptionsLimit, shownOptions)'
      },
      showNoSearchResultsWarning: {
        type: Boolean,
        value: false,
        computed: '_showNoSearchResultsWarning(noOptionsAvailable, shownOptions.length, options.length)'
      },
      autoValidate: {
        type: Boolean
      },
      placeholder: {
        type: String,
        value: 'â€”'
      },
      restoreFocusOnClose: {
        type: Boolean,
        value: function() {
          return false;
        }
      },
      twoLinesLabel: {
        type: Boolean,
        value: false,
        reflectToAttribute: true
      }
    },
    listeners: {
      'blur': '_closeMenu'
    },
    _noOptions: function() {
      return (!this.options || !this.options.length);
    },
    _menuBtnIsDisabled: function(disabled, readonly) {
      return disabled || readonly;
    },
    _getValue: function(item) {
      return item ? item[this.optionValue] : null;
    },
    _getLabel: function(item) {
      if (!item) {
        return null;
      }
      if (this.twoLinesLabel) {
        return this.getPrimaryLabel(item[this.optionLabel]);
      }
      return item[this.optionLabel];
    },
    resetInvalidState: function() {
      this.set('invalid', false);
    },
    _computeNoOptionsAvailable: function(options, optionsLength) {
      return !Array.isArray(options) || !optionsLength;
    },
    _readonlyChanged: function(newValue, oldValue) {
      if (newValue) {
        this.invalid = false;
      }
      this._attributeRepaintNeeded(newValue, oldValue);
    },
    _attributeRepaintNeeded: function(newValue, oldValue) {
      if (typeof oldValue !== 'undefined' && newValue !== undefined && newValue !== oldValue) {
        this.updateStyles();
      }
    },
    _computeShownOptions: function(options, search, showEmptyValue) {
      var shownOptions = JSON.parse(JSON.stringify(options));

      if (search) {
        shownOptions = options.filter(this._itemContainsSearchString.bind(this));
        shownOptions = this._trimByShownOptionsLimit(shownOptions);
      } else if (options.length > this.shownOptionsLimit) {
        shownOptions = this._trimByShownOptionsLimit(options);
      }

      if (showEmptyValue) {
        var emptyOption = {cssClass: 'emptyValue'};
        emptyOption[this.optionValue] = null;
        emptyOption[this.optionLabel] = '-- None --';
        shownOptions.unshift(emptyOption);
      }
      return shownOptions;
    },
    _trimByShownOptionsLimit: function(options) {
      return options.slice(0, Math.min(this.shownOptionsLimit, options.length));
    },
    _itemContainsSearchString: function(item) {
      return item[this.optionLabel] &&
          item[this.optionLabel].toString().toLowerCase().indexOf(this.search.toLowerCase()) > -1;
    },
    _computeShowLimitWarning: function(limit, shownOptions) {
      return shownOptions.length >= limit;
    },
    _showNoSearchResultsWarning: function(noOptionsAvailable, shownOptionsLength, optionsLength) {
      if (noOptionsAvailable) {
        return false;
      }
      return (optionsLength > 0 && shownOptionsLength === 0) ||
          (shownOptionsLength === 1 && this.shownOptions[0][this.optionValue] === null);
    },
    _onDropdownOpen: function() {
      var ironDropdown = this._getIronDropdown();
      if (ironDropdown) {
        // set position target to align dropdown content properly
        ironDropdown.set('positionTarget', this);
        ironDropdown.style.width = this.offsetWidth + 'px';
        var style = ironDropdown.querySelector('.dropdown-content').style;
        style.overflow = 'hidden';
      }
    },
    _getIronDropdown: function() {
      return this.$.dropdownMenu.$.dropdown;
    },
    _closeMenu: function() {
      this.$.dropdownMenu.close();
    },
    /**
     * Sometimes the dropdown doesn't resize when search is changed and we need to force the resize
     */
    _searchValueChanged: function(search) {
      this.notifyDropdownResize();
    },

    notifyDropdownResize: function() {
      var ironDropdown = this._getIronDropdown();
      if (ironDropdown) {
        ironDropdown.notifyResize();
      }
    }

  };
</script>
