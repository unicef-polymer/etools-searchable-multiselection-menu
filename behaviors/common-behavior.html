<script>
  window.etoolsSearchableDropdown = window.etoolsSearchableDropdown || {};
  /** @polymerBehavior etoolsSearchableDropdown.CommonBehavior */
  etoolsSearchableDropdown.CommonBehavior = { // eslint-disable-line no-undef
    properties: {
      label: {
        type: String
      },
      noLabelFloat: Boolean,
      required: {
        type: Boolean,
        observer: '_requiredChanged'
      },
      search: {
        type: String,
        observer: '_searchValueChanged'
      },
      options: {
        type: Array
      },
      shownOptions: {
        type: Array,
        computed: '_computeShownOptions(options, search, showEmptyValue, options.length)'
      },
      optionValue: {
        type: String,
        value: 'value'
      },
      optionLabel: {
        type: String,
        value: 'label'
      },
      dynamicAlign: {
        type: Boolean,
        value: true
      },
      allowOutsideScroll: {
        type: Boolean
      },
      showEmptyValue: {
        type: Boolean,
        value: false
      },
      hideSearch: {
        type: Boolean,
        value: false
      },
      disabled: {
        type: Boolean,
        value: false
      },
      readonly: {
        type: Boolean,
        value: function() {
          return false;
        },
        reflectToAttribute: true,
        observer: '_readonlyChanged'
      },
      invalid: {
        type: Boolean,
        value: function() {
          return false;
        },
        reflectToAttribute: true
      },
      errorMessage: {
        type: String
      },
      shownOptionsLimit: {
        type: Number,
        value: 50
      },
      noOptionsAvailable: {
        type: Boolean,
        value: true,
        computed: '_computeNoOptionsAvailable(options, options.length)'
      },
      showLimitWarning: {
        type: Boolean,
        value: false,
        computed: '_computeShowLimitWarning(shownOptionsLimit, shownOptions)'
      },
      showNoSearchResultsWarning: {
        type: Boolean,
        value: false,
        computed: '_showNoSearchResultsWarning(noOptionsAvailable, shownOptions.length, options.length)'
      },
      autoValidate: {
        type: Boolean
      },
      placeholder: {
        type: String,
        value: 'â€”'
      },
      restoreFocusOnClose: {
        type: Boolean,
        value: function() {
          return false;
        }
      },
      twoLinesLabel: {
        type: Boolean,
        value: false,
        reflectToAttribute: true
      },
      opened: {
        type: Boolean
      },
      // TODO: cleanup
      avoidHeaderOverlappingDropdown: {
        type: Boolean,
        value: false
      },
      _resizedManually: {
        type: Boolean,
        value: false
      },
      disableOnFocusHandling: {
        type: Boolean,
        value: function() {
          return this.disableOnFocusHandling || this.isIEBrowser();
        },
        reflectToAttribute: true
      },
      _lastOpenedPosition: {
        type: String,
        value: ''
      }
    },
    listeners: {
      'blur': '_closeMenu'
    },

    // TODO: cleanup
    _avoidHeaderOverlappingDropdown: function() {
      let ddContent = this._getDropdownContent();
      if (!ddContent) {
        return;
      }
      let coord = ddContent.getBoundingClientRect();
      if (!this._headerOverlapsDropdown(coord) || this._dropdownOpenedDownwards(coord)) {
        return;
      }

      if (coord.height === 0) {
        coord.height = window.getComputedStyle(ddContent).height;
        if (coord.height === 0) {
          return;
        }
      }
      ddContent.style.height = (coord.height - (60 - coord.top + 10)) + 'px';
      this._resizePaperListboxContainer(coord);

      this._resizedManually = true;
      this.async(function() {
        this.notifyDropdownResize();
        this._getIronDropdown().set('positionTarget', this);
      }, 400);
    },
    _resizePaperListboxContainer: function(overlayCoord) {
      let listWrapper = this._getListWrapper();
      let listWrapperCoord = listWrapper.getBoundingClientRect();
      listWrapper.style.height = (listWrapperCoord.height - (60 - overlayCoord.top + 10)) + 'px';
    },
    _dropdownOpenedDownwards: function(overlayCoord) {
      let paperContainerCoords = this.$.main.getBoundingClientRect();
      console.log(overlayCoord, paperContainerCoords);
      if (Math.abs(overlayCoord.top - paperContainerCoords.top) <= 10) {
        return true;
      }
      return false;
    },
    _headerOverlapsDropdown: function(clientRect) {
      return clientRect.top < 60; // 60 is the height of the pmp header
    },
    _getListWrapper: function() {
      return Polymer.dom(this.$.dropdownMenu).querySelector('.dropdown-content .list-wrapper');
    },
    _noOptions: function() {
      return (!this.options || !this.options.length);
    },
    _menuBtnIsDisabled: function(disabled, readonly) {
      return disabled || readonly;
    },
    _getValue: function(item) {
      return item ? item[this.optionValue] : null;
    },
    _getLabel: function(item) {
      if (!item) {
        return null;
      }
      if (this.twoLinesLabel) {
        return this.getPrimaryLabel(item[this.optionLabel]);
      }
      return item[this.optionLabel];
    },
    resetInvalidState: function() {
      this.set('invalid', false);
    },
    _computeNoOptionsAvailable: function(options, optionsLength) {
      return !Array.isArray(options) || !optionsLength;
    },
    _readonlyChanged: function(newValue, oldValue) {
      if (newValue) {
        this.invalid = false;
      }
      this._attributeRepaintNeeded(newValue, oldValue);
    },
    _requiredChanged: function(newValue, oldValue) {
      if (!newValue) {
        this.invalid = false;
      }
      this._attributeRepaintNeeded(newValue, oldValue);
    },
    _attributeRepaintNeeded: function(newValue, oldValue) {
      if (newValue !== undefined && newValue !== oldValue) {
        this.updateStyles();
      }
    },
    _computeShownOptions: function(options, search, showEmptyValue) {
      var shownOptions = JSON.parse(JSON.stringify(options));

      if (search) {
        shownOptions = options.filter(this._itemContainsSearchString.bind(this));
        shownOptions = this._trimByShownOptionsLimit(shownOptions);
      } else if (options.length > this.shownOptionsLimit) {
        shownOptions = this._trimByShownOptionsLimit(options);
      }

      if (showEmptyValue) {
        var emptyOption = {cssClass: 'emptyValue'};
        emptyOption[this.optionValue] = null;
        emptyOption[this.optionLabel] = '-- None --';
        shownOptions.unshift(emptyOption);
      }
      return shownOptions;
    },
    _trimByShownOptionsLimit: function(options) {
      return options.slice(0, Math.min(this.shownOptionsLimit, options.length));
    },
    _itemContainsSearchString: function(item) {
      return item[this.optionLabel] &&
          item[this.optionLabel].toString().toLowerCase().indexOf(this.search.toLowerCase()) > -1;
    },
    _computeShowLimitWarning: function(limit, shownOptions) {
      return shownOptions.length >= limit;
    },
    _showNoSearchResultsWarning: function(noOptionsAvailable, shownOptionsLength, optionsLength) {
      if (noOptionsAvailable) {
        return false;
      }
      return (optionsLength > 0 && shownOptionsLength === 0) ||
          (shownOptionsLength === 1 && this.shownOptions[0][this.optionValue] === null);
    },

    _resizeDropdownHeight: function(ironDropdown, dropdownContent) {
      let self = this;
      let dropdownContentHeightCheck = setInterval(function() {
        let dropdownVisibleHeight = dropdownContent.style.maxHeight;
        if (dropdownVisibleHeight) {
          clearInterval(dropdownContentHeightCheck);

          let searchInputWrapper = self.$$('.search-input-wrapper');
          let listWrapper = self.$$('.list-wrapper');
          let optionsList = self.$$('.list-wrapper paper-listbox');

          let searchInputWrapperHeight = Number(window.getComputedStyle(searchInputWrapper).height.replace('px', ''));
          let maxDropdownHeight = Number(dropdownVisibleHeight.replace('px', '')) - 10;
          let optionsListHeight = Number(window.getComputedStyle(optionsList).height.replace('px', ''));
          let listMaxHeight = maxDropdownHeight - (self.hideSearch ? 0 : searchInputWrapperHeight);

          if (optionsListHeight > listMaxHeight) {
            listWrapper.style.height = listMaxHeight + 'px';
            dropdownContent.style.height = maxDropdownHeight + 'px';
          } else {
            listWrapper.style.height = optionsListHeight + 'px';
            dropdownContent.style.height = ((self.hideSearch ? 0 : searchInputWrapperHeight) +
                optionsListHeight) + 'px';
          }
          let visibleDropdownContent = self.$$('.dropdown-content');
          visibleDropdownContent.style.height = dropdownVisibleHeight;
          ironDropdown.notifyResize();
        }
      }, 5);
    },

    // TODO: move everything except resize to attached callback
    _onDropdownOpen: function() {
      var ironDropdown = this._getIronDropdown();
      var listWrapper = this.$$('.list-wrapper');

      if (ironDropdown) {
        // set position target to align dropdown content properly
        ironDropdown.set('fitInto', Polymer.dom(document.querySelector('app-shell').root)
            .querySelector('#appHeadLayout').$$('#contentContainer'));
        ironDropdown.set('positionTarget', this);
        ironDropdown.set('sizingTarget', listWrapper);
        ironDropdown.style.width = this.offsetWidth + 'px';
        ironDropdown.focusTarget = this.$$('#searchInput');
        // ironDropdownContent.style.overflow = 'hidden';
//        this._resizeDropdownHeight(ironDropdown, dropdownContent);
        this.async(function() {
          var listWrapperMaxHeight = Number(listWrapper.style.maxHeight.replace('px', ''));
          var searchInputWrapper = this.$$('.search-input-wrapper');
          var searchInputWrapperHeight = Number(window.getComputedStyle(searchInputWrapper).height.replace('px', ''));
          console.log(listWrapperMaxHeight, listWrapperMaxHeight - searchInputWrapperHeight);
          listWrapper.style.maxHeight = (listWrapperMaxHeight - searchInputWrapperHeight) + 'px';
        }, 100); 
      }
    },
    _getIronDropdown: function() {
      return this.$.dropdownMenu.$.dropdown;
    },
    _getDropdownContent: function() {
      return this.$.dropdownMenu.$$('.dropdown-content');
    },
    _closeMenu: function() {
      this.$.dropdownMenu.close();

//      if (this._resizedManually) {
//        // *Reset neccessary so that dropdown becomes responsive
//        // on window resize after it's height was manually changed
//        this.refit();
//        this._resizedManually = false;
//      }
    },
    /**
     * Sometimes the dropdown doesn't resize when search is changed and we need to force the resize
     */
    _searchValueChanged: function(search) {
      this.notifyDropdownResize();
    },

    notifyDropdownResize: function() {
      var ironDropdown = this._getIronDropdown();
      if (ironDropdown) {
        ironDropdown.notifyResize();
      }
    },
    refit: function() {
      var ddContent = this._getDropdownContent();
      ddContent.style.height = 'auto';
      this._getListWrapper().style.height = 'auto';
      this.notifyDropdownResize();
    },
    _onFocusInputContainer: function() {
      if (this.disableOnFocusHandling) {
        return;
      }
      this._openMenu();
    },
    isIEBrowser: function() {
      let userAgent = window.navigator.userAgent;
      if (userAgent.indexOf('Trident/') > -1) {
        // IE 11
        return true;
      }
      return false;
    }

  };
</script>
